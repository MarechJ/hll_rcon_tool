FROM node:20-buster-slim as build

RUN apt update && apt install -y git

WORKDIR /code

# Copy package files for both old and new apps
COPY rcongui/package.json rcongui/package-lock.json ./rcongui/
COPY frontend/package.json frontend/package-lock.json ./frontend/

# Install dependencies for both apps
RUN cd rcongui && npm ci
RUN cd frontend && npm ci

# Copy source code for both apps
COPY rcongui/ ./rcongui/
COPY frontend/ ./frontend/

COPY .git/ .git/
RUN git describe --tags > /code/tag_version

# Build the old private app
ENV REACT_APP_API_URL /api/
RUN cd rcongui && npm run build
RUN mv /code/rcongui/dist /www

# Build the new public Next.js app
RUN cd frontend && npx nx build public
RUN mkdir -p /www_public && mv /code/frontend/apps/public/dist/* /www_public/

FROM nginx:mainline-alpine

RUN apk add openssl
COPY rcongui/nginx.conf /etc/nginx/conf.d/default.conf
WORKDIR /var/www

COPY --from=build /www /var/www/
COPY --from=build /www_public /var/www_public/
COPY --from=build /code/tag_version /code/tag_version

VOLUME /certs
COPY rcongui/entrypoint.sh /code/entrypoint.sh
RUN chmod +x /code/entrypoint.sh

ENTRYPOINT [ "/code/entrypoint.sh" ]
